// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  name          String
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  role          String    @default("VENDOR")
  banned        Boolean?  @default(false)
  banReason     String?
  banExpires    DateTime?
  phone         String?
  companyId     String?
  vendorId      String?

  sessions      Session[]
  accounts      Account[]
  Vendor        Vendor?         @relation(fields: [vendorId], references: [id])
  PurchaseOrder PurchaseOrder[]

  @@map("users")
}

model Vendor {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  name         String
  contactEmail String?
  contactPhone String?
  gstNumber    String?
  panNumber    String?

  profileCompleted Boolean @default(false)
  taxId            String?
  paymentTerms     String?
  isActive         Boolean @default(true)

  users User[]

  // vehicles      Vehicle[]
  invoices      Invoice[]
  PurchaseOrder PurchaseOrder[]
  Address       Address[]
  // docs          Document[]
  LRRequest     LRRequest[]

  @@map("vendors")
}

model Document {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  label       String
  url         String?
  entryBy     String?
  description String?

  linkedId String @unique

  @@map("documents")
}

model Address {
  id String @id @default(uuid())

  line1   String
  line2   String?
  city    String
  state   String?
  postal  String?
  country String

  vendorId String @unique
  vendor   Vendor @relation(fields: [vendorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("addresses")
}

model LRRequest {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vehicleType  String?
  vehicleNo    String?
  CustomerName String?
  LRNumber     String   @unique
  origin       String?
  destination  String?
  outDate      DateTime
  status       String?  @default("PENDING") // WRONG, VERIFIED
  priceOffered Float?
  priceSettled Float?
  extraCost    Float?
  fileNumber   String
  remark       String?
  isInvoiced   Boolean  @default(false)

  podlink   String?
  tvendorId String
  tvendor   Vendor   @relation(fields: [tvendorId], references: [id], onUpdate: NoAction, onDelete: NoAction)
  invoiceId String?
  Invoice   Invoice? @relation(fields: [invoiceId], references: [id])
}

model Invoice {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invoiceNumber  String?
  refernceNumber String   @unique
  invoiceDate    DateTime
  vendorId       String
  poId           String?
  status         String   @default("DRAFT") // sent
  subtotal       Float    @default(0)
  taxRate        Float    @default(0)
  taxAmount      Float    @default(0)
  totalExtra     Float    @default(0)
  grandTotal     Float    @default(0)
  notes          String?

  hasDiscrepancy   Boolean            @default(false)
  discrepancyNotes String?
  billTo           String?
  billToId         String?
  billToGstin      String?
  invoiceURI       String?
  vendor           Vendor             @relation(fields: [vendorId], references: [id], onUpdate: NoAction, onDelete: NoAction)
  purchaseOrder    PurchaseOrder?     @relation(fields: [poId], references: [id])
  items            InvoiceItem[]
  LRRequest        LRRequest[]
  InvoiceReference InvoiceReference[]

  @@map("invoices")
}

model InvoiceReference {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  from     DateTime
  to       DateTime
  dueDate  DateTime?
  paidDate DateTime?

  refernceId      String
  invoiceRefernce Invoice @relation(fields: [refernceId], references: [refernceNumber])
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  description String
  quantity    Int
  unitPrice   Float
  total       Float
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_items")
}

model PurchaseOrder {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  poNumber        String    @unique
  poDate          DateTime
  status          String    @default("DRAFT")
  subtotal        Float     @default(0)
  taxRate         Float     @default(0)
  taxAmount       Float     @default(0)
  grandTotal      Float     @default(0)
  notes           String?
  attachments     String? // JSON string of file URLs
  deliveryDate    DateTime?
  deliveryAddress String?
  invoiceCopy     String? // JSON string of invoice copy file URLs

  vendorId String
  vendor   Vendor @relation(fields: [vendorId], references: [id], onUpdate: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onUpdate: NoAction, onDelete: NoAction)

  items    PurchaseOrderItem[]
  invoices Invoice[]

  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id          String   @id @default(cuid())
  poId        String
  description String
  quantity    Int
  unitPrice   Float
  total       Float
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  purchaseOrder PurchaseOrder @relation(fields: [poId], references: [id], onDelete: Cascade)

  @@map("purchase_order_items")
}

model Session {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  expiresAt      DateTime
  token          String   @unique
  ipAddress      String?
  userAgent      String?
  impersonatedBy String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Account {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accountId  String
  providerId String

  // ðŸ”¹ Changed to @db.Text to handle long token strings
  accessToken  String? @db.Text
  refreshToken String? @db.Text
  idToken      String? @db.Text // âœ… main fix
  scope        String? @db.Text
  password     String?

  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("accounts")
}

model Verification {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  identifier String
  value      String
  expiresAt  DateTime

  @@map("verifications")
}

model LorryReceipt {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lrNo        String @unique // OutLRNo
  lrDate      String // OutLRDate
  city        String // City
  transporter String // OutTPT
  warehouse   String // WH
  vehicleType String // OutVehType
  vehicleNo   String // OutVehNo

  @@map("lorry_receipts") // prisma table name
}
