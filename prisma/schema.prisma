// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlserver"
}

model User {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  name          String
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  role          String    @default("VENDOR")
  banned        Boolean?  @default(false)
  banReason     String?
  banExpires    DateTime?
  phone         String?
  companyId     String?
  vendorId      String?

  sessions                Session[]
  accounts                Account[]
  Vendor                  Vendor?                 @relation(fields: [vendorId], references: [id])
  PurchaseOrder           PurchaseOrder[]
  logs                    Log[]
  workflowComments        WorkflowComment[]
  invoiceStatusHistories  InvoiceStatusHistory[]
  annexureStatusHistories AnnexureStatusHistory[]

  @@map("users")
}

model Vendor {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  name             String
  contactEmail     String?
  contactPhone     String?
  gstNumber        String?
  panNumber        String?
  profileCompleted Boolean @default(false)
  taxId            String?
  paymentTerms     String?
  isActive         Boolean @default(true)

  users User[]

  // vehicles      Vehicle[]
  invoices      Invoice[]
  PurchaseOrder PurchaseOrder[]
  Address       Address[]
  // docs          Document[]
  LRRequest     LRRequest[]
  logs          Log[]
  annexures     Annexure[]

  @@map("vendors")
}

model Address {
  id String @id @default(uuid())

  line1   String
  line2   String?
  city    String
  state   String?
  postal  String?
  country String

  vendorId String @unique
  vendor   Vendor @relation(fields: [vendorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("addresses")
}

model LRRequest {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vehicleType  String?
  vehicleNo    String?
  CustomerName String?
  LRNumber     String   @unique
  origin       String?
  destination  String?
  outDate      DateTime
  status       String?  @default("PENDING") // REJECTED, APPROVED

  // pricing 
  priceOffered  Float?
  lrPrice       Float?
  modifiedPrice Float?
  priceSettled  Float?
  extraCost     Float?
  fileNumber    String
  remark        String?
  isInvoiced    Boolean @default(false)

  podlink   String?
  tvendorId String
  tvendor   Vendor   @relation(fields: [tvendorId], references: [id], onUpdate: NoAction, onDelete: NoAction)
  invoiceId String?
  Invoice   Invoice? @relation(fields: [invoiceId], references: [id])

  annexureId String?
  Annexure   Annexure? @relation(fields: [annexureId], references: [id], onUpdate: NoAction, onDelete: NoAction)

  groupId String?
  group   AnnexureFileGroup? @relation(fields: [groupId], references: [id])
}

model Document {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  label       String //Pan Card
  url         String
  entryBy     String
  description String?

  linkedId   String
  linkedCode String? //pan_card, gst_certificate

  @@unique([linkedId, linkedCode])
  @@map("documents")
}

model extraCostList {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  docNo       String
  description String
  amount      Float
  docId       String

  @@index([docNo])
}

model Annexure {
  id       String   @id @default(uuid())
  name     String
  fromDate DateTime
  toDate   DateTime

  status            String    @default("DRAFT")
  submittedAt       DateTime?
  tadminCompletedAt DateTime?
  bossApprovedAt    DateTime?
  rejectedAt        DateTime?
  currentReviewer   String?

  vendorId String?
  vendor   Vendor? @relation(fields: [vendorId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  LRRequest        LRRequest[]
  groups           AnnexureFileGroup[]
  statusHistory    AnnexureStatusHistory[]
  workflowComments WorkflowComment[]
  invoices         Invoice[]

  @@map("Annexure")
}

model AnnexureFileGroup {
  id         String   @id @default(uuid())
  annexureId String
  fileNumber String
  totalPrice Float?
  extraCost  Float?
  remark     String?
  status     String   @default("PENDING")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  reviewedBy      String?
  reviewedAt      DateTime?
  approvedBy      String?
  approvedAt      DateTime?
  rejectedBy      String?
  rejectedAt      DateTime?
  rejectionReason String?   @db.NVarChar(Max)

  Annexure   Annexure                     @relation(fields: [annexureId], references: [id])
  LRs        LRRequest[]
  rejections AnnexureFileGroupRejection[]

  @@map("AnnexureFileGroup")
}

model Invoice {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invoiceNumber  String?
  refernceNumber String   @unique
  invoiceDate    DateTime
  vendorId       String
  poId           String?
  status         String   @default("DRAFT")
  subtotal       Float    @default(0)
  taxRate        Float    @default(0)
  taxAmount      Float    @default(0)
  totalExtra     Float    @default(0)
  grandTotal     Float    @default(0)
  notes          String?

  hasDiscrepancy    Boolean @default(false)
  discrepancyNotes  String?
  billTo            String?
  billToId          String?
  billToGstin       String?
  invoiceURI        String?
  deletionRequested Boolean @default(false)

  currentReviewer   String?
  submittedAt       DateTime?
  tadminApprovedAt  DateTime?
  bossApprovedAt    DateTime?
  rejectedAt        DateTime?
  paymentApprovedAt DateTime?

  annexureId String?
  annexure   Annexure? @relation(fields: [annexureId], references: [id], onUpdate: NoAction, onDelete: NoAction)

  vendor           Vendor                 @relation(fields: [vendorId], references: [id], onUpdate: NoAction, onDelete: NoAction)
  purchaseOrder    PurchaseOrder?         @relation(fields: [poId], references: [id])
  items            InvoiceItem[]
  LRRequest        LRRequest[]
  InvoiceReference InvoiceReference[]
  statusHistory    InvoiceStatusHistory[]
  rejections       InvoiceRejection[]
  workflowComments WorkflowComment[]

  @@map("invoices")
}

model InvoiceStatusHistory {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  fromStatus    String?
  toStatus      String
  changedBy     String // userId
  changedByUser User    @relation(fields: [changedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  notes         String? @db.NVarChar(Max)

  @@index([invoiceId])
  @@index([createdAt])
  @@map("invoice_status_history")
}

model AnnexureStatusHistory {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  annexureId String
  annexure   Annexure @relation(fields: [annexureId], references: [id], onDelete: Cascade)

  fromStatus    String?
  toStatus      String
  changedBy     String
  changedByUser User    @relation(fields: [changedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  notes         String? @db.NVarChar(Max)

  @@index([annexureId])
  @@index([createdAt])
  @@map("annexure_status_history")
}

model InvoiceRejection {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  rejectedBy String
  rejectedAt DateTime @default(now())
  reason     String   @db.NVarChar(Max)
  status     String // Which status was it in when rejected

  @@index([invoiceId])
  @@map("invoice_rejections")
}

model AnnexureFileGroupRejection {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  fileGroupId String
  fileGroup   AnnexureFileGroup @relation(fields: [fileGroupId], references: [id], onDelete: Cascade)

  rejectedBy String
  rejectedAt DateTime @default(now())
  reason     String   @db.NVarChar(Max)

  affectedLRs String? @db.NVarChar(Max)

  @@index([fileGroupId])
  @@map("annexure_file_group_rejections")
}

model EmailNotificationLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  recipientEmail String
  recipientId    String?
  subject        String
  body           String  @db.NVarChar(Max)
  templateType   String // "REJECTION", "APPROVAL", "STATUS_CHANGE"

  relatedModel String? // "Invoice", "Annexure", "AnnexureFileGroup"
  relatedId    String?

  sentAt DateTime?
  status String    @default("PENDING") // PENDING, SENT, FAILED
  error  String?   @db.NVarChar(Max)

  @@index([recipientId])
  @@index([createdAt])
  @@index([status])
  @@map("email_notifications")
}

model InvoiceReference {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  from     DateTime
  to       DateTime
  dueDate  DateTime?
  paidDate DateTime?

  refernceId      String
  invoiceRefernce Invoice @relation(fields: [refernceId], references: [refernceNumber])
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  description String
  quantity    Int
  unitPrice   Float
  total       Float
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_items")
}

model PurchaseOrder {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  poNumber        String    @unique
  poDate          DateTime
  status          String    @default("DRAFT")
  subtotal        Float     @default(0)
  taxRate         Float     @default(0)
  taxAmount       Float     @default(0)
  grandTotal      Float     @default(0)
  notes           String?
  attachments     String? // JSON string of file URLs
  deliveryDate    DateTime?
  deliveryAddress String?
  invoiceCopy     String? // JSON string of invoice copy file URLs

  vendorId String
  vendor   Vendor @relation(fields: [vendorId], references: [id], onUpdate: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onUpdate: NoAction, onDelete: NoAction)

  items    PurchaseOrderItem[]
  invoices Invoice[]

  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id          String   @id @default(cuid())
  poId        String
  description String
  quantity    Int
  unitPrice   Float
  total       Float
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  purchaseOrder PurchaseOrder @relation(fields: [poId], references: [id], onDelete: Cascade)

  @@map("purchase_order_items")
}

model Session {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  expiresAt      DateTime
  token          String   @unique
  ipAddress      String?
  userAgent      String?
  impersonatedBy String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Account {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accountId  String
  providerId String

  // ðŸ”¹ Changed to @db.Text to handle long token strings
  accessToken  String? @db.Text
  refreshToken String? @db.Text
  idToken      String? @db.Text // âœ… main fix
  scope        String? @db.Text
  password     String?

  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("accounts")
}

model Verification {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  identifier String
  value      String
  expiresAt  DateTime

  @@map("verifications")
}

model LorryReceipt {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lrNo        String @unique // OutLRNo
  lrDate      String // OutLRDate
  city        String // City
  transporter String // OutTPT
  warehouse   String // WH
  vehicleType String // OutVehType
  vehicleNo   String // OutVehNo

  @@map("lorry_receipts") // prisma table name
}

model Log {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  action   String // "CREATE" | "UPDATE" | "DELETE"
  model    String // "LRRequest", "Invoice", etc.
  recordId String? // id of the affected record

  vendorId String? // to restrict vendor-scoped access
  Vendor   Vendor? @relation(fields: [vendorId], references: [id], onUpdate: NoAction, onDelete: NoAction)

  oldData String? @db.NVarChar(Max) // stringified JSON
  newData String? @db.NVarChar(Max) // stringified JSON

  description String? // optional human-readable text

  @@index([model])
  @@index([recordId])
  @@index([vendorId])
  @@index([createdAt])
}

model WorkflowComment {
  id             String   @id @default(cuid())
  content        String   @db.NVarChar(Max)
  authorId       String
  authorRole     String
  isPrivate      Boolean  @default(false)
  attachmentUrl  String?  @db.NVarChar(Max)
  attachmentName String?  @db.NVarChar(Max)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @default(now()) @updatedAt

  // Link to either Annexure or Invoice
  annexureId String?
  invoiceId  String?

  Annexure Annexure? @relation(fields: [annexureId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Invoice  Invoice?  @relation(fields: [invoiceId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Author   User      @relation(fields: [authorId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([annexureId])
  @@index([invoiceId])
  @@index([authorId])
  @@index([createdAt])
}
